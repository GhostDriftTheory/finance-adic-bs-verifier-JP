<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BSモデル完全保証デモ v4.0</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for React & Icons -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0"
        }
    }
    </script>

    <style>
        /* Dark Theme Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #020617; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
        body {
            background-color: #020617; /* slate-950 */
            color: #e2e8f0; /* slate-200 */
            -webkit-tap-highlight-color: transparent;
        }
        /* Mobile Table Optimization */
        .table-container {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            ShieldCheck, Database, Calculator, Lock, CheckCircle, XCircle, 
            BookOpen, Info, Hash, Upload, Copy, Check, Download, RotateCcw
        } from 'lucide-react';

        /**
         * FinanceAdic: Black-Scholes Structure Visualizer & Guarantor (v4.1: JP Localized & Mobile Optimized)
         * - 全UI要素を平易な日本語に翻訳
         * - スマホでのタップ領域と可読性を最適化
         */

        // --- 1. Global Certificate Constants ---
        const DOMAIN_D = {
            S: [50, 200],
            K: [50, 200],
            T: [0.1, 3.0],
            v: [0.1, 1.0],
            r: [0.00, 0.10]
        };
        const DELTA_PRICE_GLOBAL = 3.3e-6;
        const ERR_BASE = 1e-15; 
        const ERR_APPROX_NORMSDIST = 1e-7;

        // --- 2. Math Helpers ---
        function erf(x) {
            const sign = x >= 0 ? 1 : -1;
            x = Math.abs(x);
            const a1 = 0.254829592; const a2 = -0.284496736; const a3 = 1.421413741;
            const a4 = -1.453152027; const a5 = 1.061405429; const p = 0.3275911;
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            return sign * y;
        }
        function normalCdf(x) { return 0.5 * (1 + erf(x / Math.sqrt(2))); }
        const pdf = (x) => Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);

        // Crypto Helper
        const sha256 = async (message) => {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        };

        // --- 3. ADIC Kernel Logic ---
        const computeBS_ADIC = async (S, K, T, r, v) => {
            const ledger = [];
            let stepId = 1;
            const idMap = new Map();
            let prevHash = '0'.repeat(64);

            const record = async (op, desc, val, err, deps = [], interval = null) => {
                const calculatedInterval = interval || [val - err, val + err];
                const payload = { id: stepId, op, desc, value: val, error: err, deps };
                const payloadStr = JSON.stringify(payload);
                const hash = await sha256(prevHash + '|' + payloadStr);

                const row = {
                    id: stepId++, op, desc, value: val, error: err,
                    interval: calculatedInterval, deps, hash, prevHash,
                    verified: null, diff: 0
                };
                prevHash = hash;
                ledger.push(row);
                return row;
            };

            const inputParams = { S, K, T, r, v };
            for (const [key, val] of Object.entries(inputParams)) {
                const row = await record('INPUT', `${key} (入力)`, val, 0, []);
                idMap.set(key, row.id);
            }
            const getId = (key) => idMap.get(key);
            const getRow = (id) => ledger.find(r => r.id === id);

            const id_S = getId('S'); const id_K = getId('K');
            const row_ln = await record('LOG', `対数収益率 ln(S/K)`, Math.log(getRow(id_S).value / getRow(id_K).value), ERR_BASE * 10, [id_S, id_K]);

            const id_r = getId('r'); const id_v = getId('v'); const id_T = getId('T');
            const val_r = getRow(id_r).value; const val_v = getRow(id_v).value; const val_T = getRow(id_T).value;
            const vol_term_val = (val_r + (val_v * val_v) / 2) * val_T;
            const row_vol_term = await record('MUL', `ボラティリティ項`, vol_term_val, ERR_BASE * 10, [id_r, id_v, id_T]);

            const denom_val = val_v * Math.sqrt(val_T);
            const row_denom = await record('SQRT', `分母項 σ√T`, denom_val, ERR_BASE * 5, [id_v, id_T]);

            const d1_val = (row_ln.value + row_vol_term.value) / row_denom.value;
            const d1_err = (row_ln.error + row_vol_term.error) / row_denom.value + ERR_BASE; 
            const row_d1 = await record('D1', `パラメータ d1`, d1_val, d1_err, [row_ln.id, row_vol_term.id, row_denom.id]);
            const row_d2 = await record('D2', `パラメータ d2`, d1_val - row_denom.value, row_d1.error + row_denom.error + ERR_BASE, [row_d1.id, row_denom.id]);

            const nd1_val = normalCdf(d1_val);
            const row_nd1 = await record('CDF', `確率 N(d1)`, nd1_val, ERR_APPROX_NORMSDIST + (pdf(d1_val) * row_d1.error), [row_d1.id]);
            const nd2_val = normalCdf(row_d2.value);
            const row_nd2 = await record('CDF', `確率 N(d2)`, nd2_val, ERR_APPROX_NORMSDIST + (pdf(row_d2.value) * row_d2.error), [row_d2.id]);

            const disc_val = Math.exp(-val_r * val_T);
            const row_disc = await record('EXP', `割引係数`, disc_val, ERR_BASE * 10, [id_r, id_T]);

            const term1 = getRow(id_S).value * nd1_val;
            const term2 = getRow(id_K).value * disc_val * nd2_val;
            const price_val = term1 - term2;
            const price_err = DELTA_PRICE_GLOBAL; 
            
            const row_price = await record('PRICE', `理論価格 (Call)`, price_val, price_err, [id_S, row_nd1.id, id_K, row_disc.id, row_nd2.id]);

            return { 
                price: price_val, error: price_err, ledger,
                c_min: price_val - price_err, c_max: price_val + price_err,
                rootHash: prevHash, domain: DOMAIN_D, delta_global: DELTA_PRICE_GLOBAL
            };
        };

        // --- 4. Verification Logic ---
        const recomputeRow = (row, rowMap) => {
            const get = (id) => {
                const r = rowMap.get(id); if (!r) throw new Error(`Missing dependency ID: ${id}`); return r.value;
            };
            switch (row.op) {
                case 'INPUT': return row.value;
                case 'LOG': return Math.log(get(row.deps[0]) / get(row.deps[1]));
                case 'MUL': { const r=get(row.deps[0]); const v=get(row.deps[1]); const T=get(row.deps[2]); return (r+(v*v)/2)*T; }
                case 'SQRT': return get(row.deps[0]) * Math.sqrt(get(row.deps[1]));
                case 'D1': return (get(row.deps[0]) + get(row.deps[1])) / get(row.deps[2]);
                case 'D2': return get(row.deps[0]) - get(row.deps[1]);
                case 'CDF': return normalCdf(get(row.deps[0]));
                case 'EXP': return Math.exp(-get(row.deps[0]) * get(row.deps[1]));
                case 'PRICE': return get(row.deps[0]) * get(row.deps[1]) - get(row.deps[2]) * get(row.deps[3]) * get(row.deps[4]);
                default: return row.value;
            }
        };

        const verifyLedger = async (ledger) => {
            const rowMap = new Map();
            const verifiedRows = [];
            let allNumericOk = true;
            let allHashOk = true;
            let expectedPrevHash = '0'.repeat(64);

            for (const row of ledger) {
                let recomputedVal = (row.op === 'INPUT') ? row.value : recomputeRow(row, rowMap);
                rowMap.set(row.id, row);
                const diff = Math.abs(recomputedVal - row.value);
                
                let numericOk = false;
                if (row.op === 'PRICE') numericOk = diff <= DELTA_PRICE_GLOBAL; 
                else numericOk = diff <= (row.error === 0 ? 1e-14 : row.error * 1.1 + 1e-14);
                if (!numericOk) allNumericOk = false;

                const payload = { id: row.id, op: row.op, desc: row.desc, value: row.value, error: row.error, deps: row.deps };
                const recomputedHash = await sha256(expectedPrevHash + '|' + JSON.stringify(payload));
                const hashOk = (row.prevHash === expectedPrevHash) && (row.hash === recomputedHash);
                if (!hashOk) allHashOk = false;
                expectedPrevHash = row.hash;

                verifiedRows.push({ ...row, verified: numericOk && hashOk, diff });
            }
            return { ok: allNumericOk && allHashOk, numericOk, hashOk: allHashOk, rows: verifiedRows, rootHash: expectedPrevHash };
        };

        // --- 5. UI Component ---
        const FinanceAdic = () => {
            const DEFAULT_PARAMS = { S: 100, K: 100, T: 1, r: 0.05, v: 0.2 };
            const [params, setParams] = useState(DEFAULT_PARAMS);
            const [result, setResult] = useState(null);
            const [isVerifying, setIsVerifying] = useState(false);
            const [verifiedLedger, setVerifiedLedger] = useState(null);
            const [certRange, setCertRange] = useState(null);
            const [activeTab, setActiveTab] = useState('live'); 
            const [copied, setCopied] = useState(false);
            const [importJson, setImportJson] = useState('');
            const [importResult, setImportResult] = useState(null);
            const [isImportVerifying, setIsImportVerifying] = useState(false);

            useEffect(() => { runCalculation(); }, []);

            const runCalculation = async () => {
                setVerifiedLedger(null); setCertRange(null);
                const res = await computeBS_ADIC(params.S, params.K, params.T, params.r, params.v);
                setResult(res);
            };

            const handleVerify = async () => {
                if (!result) return;
                setIsVerifying(true);
                setTimeout(async () => {
                    const verifyResult = await verifyLedger(result.ledger);
                    setVerifiedLedger(verifyResult.rows);
                    setIsVerifying(false);
                    if (verifyResult.ok) setCertRange({ min: result.c_min, max: result.c_max });
                }, 600);
            };

            const handleDownload = () => {
                if (!result) return;
                const dataToSave = {
                    kernel: "FinanceAdic-BS-v4.1-JP",
                    domain: DOMAIN_D,
                    delta_price_global: DELTA_PRICE_GLOBAL,
                    rootHash: result.rootHash,
                    ledger: verifiedLedger || result.ledger 
                };
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: "application/json" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `ProofLedger_${result.rootHash.substr(0,8)}.json`;
                link.click();
            };

            const handleParamChange = (key, val) => {
                setParams(prev => ({ ...prev, [key]: parseFloat(val) }));
                setVerifiedLedger(null); setCertRange(null);
            };

            const copyRootHash = () => {
                if (!result) return;
                navigator.clipboard.writeText(result.rootHash);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const handleImportVerify = async () => {
                if (!importJson) return;
                setIsImportVerifying(true); setImportResult(null);
                try {
                    const data = JSON.parse(importJson);
                    if (!data.ledger || !Array.isArray(data.ledger)) throw new Error("形式が無効です");
                    const vRes = await verifyLedger(data.ledger);
                    setImportResult({
                        ok: vRes.ok, numericOk: vRes.numericOk, hashOk: vRes.hashOk,
                        rootHash: vRes.rootHash, delta: data.delta_price_global || "不明"
                    });
                } catch (e) { setImportResult({ error: e.message }); }
                setIsImportVerifying(false);
            };

            // ラベル辞書
            const labels = {
                S: "株価 (S)", K: "行使価格 (K)", T: "期間 (年)", v: "変動率 (σ)", r: "金利 (r)"
            };

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-slate-200 font-sans overflow-hidden">
                    
                    {/* Header */}
                    <header className="flex-shrink-0 flex items-center justify-between px-4 py-3 border-b border-slate-800 bg-slate-900/90 backdrop-blur-sm z-20">
                        <div className="flex items-center gap-2.5">
                            <div className="p-1.5 bg-indigo-500/20 rounded-lg border border-indigo-500/30">
                                <BookOpen className="w-4 h-4 text-indigo-400" />
                            </div>
                            <div>
                                <h1 className="text-sm md:text-lg font-bold text-white tracking-wide">
                                    BSモデル × ADIC <span className="text-emerald-400 text-xs">v4.0</span>
                                </h1>
                                <p className="text-[10px] text-slate-400">構造可視化・完全保証デモ</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-1.5 text-[10px] text-emerald-400 bg-emerald-950/30 px-2 py-1 rounded-full border border-emerald-900/50">
                            <Lock className="w-3 h-3" />
                            <span className="font-medium">保護中</span>
                        </div>
                    </header>

                    <main className="flex-1 flex flex-col md:flex-row overflow-hidden">
                        
                        {/* LEFT PANE: 設定 & 証明 */}
                        <aside className="w-full md:w-[420px] border-b md:border-b-0 md:border-r border-slate-800 bg-slate-900/30 flex flex-col overflow-y-auto">
                            <div className="p-4 md:p-6 space-y-6">
                                
                                {/* 目的・意義 */}
                                <div className="bg-slate-800/40 rounded-xl border border-slate-700/50 p-4 shadow-sm">
                                    <h2 className="text-xs font-bold text-white flex items-center gap-2 mb-3">
                                        <Info className="w-3.5 h-3.5 text-cyan-400" />
                                        はじめに：信頼の起点として
                                    </h2>
                                    
                                    <div className="space-y-3 text-xs text-slate-300 leading-relaxed">
                                        <div>
                                            <strong className="text-slate-200 block mb-1">Q. 何が変わったのか？</strong>
                                            計算結果を「その場の計算」ではなく、<strong className="text-emerald-300">「数学的に証明された誤差範囲」</strong>と<strong className="text-emerald-300">「改ざん検知チェーン」</strong>で二重に保証します。
                                        </div>
                                        
                                        <div className="grid grid-cols-1 gap-2">
                                            <div className="bg-indigo-900/20 border border-indigo-500/20 rounded-lg p-2.5">
                                                <div className="text-[10px] font-bold text-indigo-300 mb-1 flex items-center gap-1.5">
                                                    <ShieldCheck className="w-3 h-3" /> 【効力】数学的な誤差保証
                                                </div>
                                                <span className="text-[10px] text-slate-400 block leading-snug">
                                                    表示される誤差範囲は、デモ用の目安ではなく、入力可能な全範囲に対して数学的に証明された絶対的な安全圏です。
                                                </span>
                                            </div>
                                            <div className="bg-emerald-900/10 border border-emerald-500/20 rounded-lg p-2.5">
                                                <div className="text-[10px] font-bold text-emerald-400 mb-1 flex items-center gap-1.5">
                                                    <Hash className="w-3 h-3" /> 【耐性】改ざん検知チェーン
                                                </div>
                                                <span className="text-[10px] text-slate-400 block leading-snug">
                                                    台帳の各行は前の行の暗号ハッシュを含みます。1箇所でも改ざんされると、検証時に即座に検知されます。
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 手順1: 入力 */}
                                <div className="space-y-3">
                                    <h3 className="text-[11px] font-bold text-slate-500 uppercase flex items-center gap-1.5">
                                        <Calculator className="w-3.5 h-3.5" /> 手順1: 条件を入力 (Domain D)
                                    </h3>
                                    
                                    <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-800 space-y-4">
                                        {Object.entries(DOMAIN_D).map(([k, range]) => (
                                            <div key={k} className="space-y-1.5">
                                                <div className="flex justify-between text-xs items-center">
                                                    <span className="text-slate-400 font-medium">{labels[k]}</span>
                                                    <span className="text-cyan-400 font-mono font-bold text-sm">{params[k]}</span>
                                                </div>
                                                <input 
                                                    type="range" min={range[0]} max={range[1]} step={k === 'S' || k === 'K' ? 1 : 0.01}
                                                    value={params[k]}
                                                    onChange={(e) => handleParamChange(k, e.target.value)}
                                                    className="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-cyan-500 touch-manipulation"
                                                />
                                                <div className="flex justify-between text-[9px] text-slate-600 font-mono">
                                                    <span>{range[0]}</span>
                                                    <span>{range[1]}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* 手順2: 検証 */}
                                <div className="space-y-3 pb-8 md:pb-0">
                                   <h3 className="text-[11px] font-bold text-slate-500 uppercase flex items-center gap-1.5">
                                        <ShieldCheck className="w-3.5 h-3.5" /> 手順2: 証明書を発行
                                    </h3>

                                   <button 
                                     onClick={handleVerify}
                                     disabled={isVerifying || verifiedLedger}
                                     className={`w-full py-3.5 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-md active:scale-[0.98] touch-manipulation ${
                                       verifiedLedger 
                                         ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/50 cursor-default'
                                         : 'bg-indigo-600 hover:bg-indigo-500 text-white shadow-indigo-500/20'
                                     }`}
                                   >
                                     {isVerifying ? <RotateCcw className="w-4 h-4 animate-spin" /> : verifiedLedger ? <Lock className="w-4 h-4" /> : <ShieldCheck className="w-4 h-4" />}
                                     {verifiedLedger ? '証明書の発行完了' : isVerifying ? '台帳を検証中...' : '検証を実行 (Verify)'}
                                   </button>

                                   {result && (
                                    <div className={`p-4 rounded-xl border transition-all duration-500 ${certRange ? 'bg-emerald-950/20 border-emerald-500/30' : 'bg-slate-800/50 border-slate-700'}`}>
                                      <div className="flex justify-between items-end mb-3">
                                        <span className="text-[10px] text-slate-500 font-bold tracking-wider">理論価格 (BS)</span>
                                        <span className="text-3xl font-mono font-bold text-white">{result.price.toFixed(4)}</span>
                                      </div>

                                      {certRange ? (
                                         <div className="animate-in fade-in slide-in-from-bottom-1 pt-3 border-t border-emerald-500/20">
                                           <div className="flex justify-between items-center mb-2">
                                             <div className="flex items-center gap-1.5">
                                               <Lock className="w-3 h-3 text-emerald-400" />
                                               <span className="text-[10px] font-bold text-emerald-400">100%保証された範囲</span>
                                             </div>
                                             <div className="text-[9px] font-mono text-emerald-600">
                                               誤差: ±{DELTA_PRICE_GLOBAL.toExponential(1)}
                                             </div>
                                           </div>
                                           <div className="flex gap-2 text-[11px] font-mono text-emerald-200">
                                             <div className="flex-1 bg-emerald-500/10 py-1.5 px-3 rounded flex justify-between items-center">
                                               <span className="opacity-50 text-[9px]">最小</span><span>{certRange.min.toFixed(5)}</span>
                                             </div>
                                             <div className="flex-1 bg-emerald-500/10 py-1.5 px-3 rounded flex justify-between items-center">
                                               <span className="opacity-50 text-[9px]">最大</span><span>{certRange.max.toFixed(5)}</span>
                                             </div>
                                           </div>
                                         </div>
                                      ) : (
                                        <div className="pt-2 border-t border-slate-700 text-center text-[10px] text-slate-500">
                                          上のボタンを押して、正当性を証明してください
                                        </div>
                                      )}
                                    </div>
                                  )}
                                </div>
                            </div>
                        </aside>

                        {/* RIGHT PANE: 台帳 & ラボ */}
                        <div className="flex-1 flex flex-col bg-slate-950 min-w-0">
                            
                            {/* Tabs Navigation */}
                            <div className="flex-shrink-0 px-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center sticky top-0 z-10 backdrop-blur-md h-12">
                                <div className="flex gap-6 h-full">
                                    <button 
                                        onClick={() => setActiveTab('live')}
                                        className={`text-xs font-bold flex items-center gap-2 h-full border-b-2 transition-colors ${activeTab === 'live' ? 'text-white border-indigo-500' : 'text-slate-500 border-transparent hover:text-slate-300'}`}
                                    >
                                        <Database className="w-3.5 h-3.5" />
                                        証明台帳 (Live)
                                    </button>
                                    <button 
                                        onClick={() => setActiveTab('import')}
                                        className={`text-xs font-bold flex items-center gap-2 h-full border-b-2 transition-colors ${activeTab === 'import' ? 'text-white border-emerald-500' : 'text-slate-500 border-transparent hover:text-slate-300'}`}
                                    >
                                        <Upload className="w-3.5 h-3.5" />
                                        外部ログ検証
                                    </button>
                                </div>
                                
                                {activeTab === 'live' && (
                                    <div className="flex items-center gap-2">
                                        {result && (
                                            <button 
                                                onClick={copyRootHash}
                                                className="hidden md:flex items-center gap-2 px-2.5 py-1.5 bg-slate-800 rounded text-[10px] font-mono text-slate-400 hover:text-white transition-colors border border-slate-700"
                                                title="ルートハッシュをコピー"
                                            >
                                                <Hash className="w-3 h-3 text-emerald-500" />
                                                {result.rootHash.substr(0, 8)}...
                                                {copied ? <Check className="w-3 h-3" /> : <Copy className="w-3 h-3" />}
                                            </button>
                                        )}
                                        <button 
                                            onClick={handleDownload}
                                            className="flex items-center gap-1.5 px-3 py-1.5 text-[10px] text-slate-400 hover:text-white hover:bg-slate-800 rounded border border-slate-800 transition-all font-bold"
                                        >
                                            <Download className="w-3 h-3" /> <span className="hidden md:inline">JSON保存</span><span className="md:hidden">保存</span>
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* Content */}
                            <div className="flex-1 overflow-hidden relative bg-slate-950">
                                
                                {/* TAB: 証明台帳 */}
                                {activeTab === 'live' && (
                                    <div className="h-full overflow-auto table-container">
                                        <table className="w-full text-left border-collapse min-w-[600px] md:min-w-0">
                                            <thead className="sticky top-0 z-10">
                                                <tr className="bg-slate-900 text-[10px] text-slate-500 font-bold border-b border-slate-800 shadow-sm">
                                                    <th className="px-3 py-2.5 w-10 text-center">No.</th>
                                                    <th className="px-3 py-2.5 w-16">操作</th>
                                                    <th className="px-3 py-2.5 w-auto">計算内容</th>
                                                    <th className="px-3 py-2.5 w-24 text-right">値</th>
                                                    <th className="px-3 py-2.5 w-20 text-right">ハッシュ(冒頭)</th>
                                                    <th className="px-3 py-2.5 w-16 text-center">状態</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-900 md:divide-slate-800 text-[11px] font-mono">
                                                {(verifiedLedger || (result ? result.ledger : [])).map((row) => (
                                                    <tr 
                                                        key={row.id} 
                                                        className={`bg-slate-950 hover:bg-slate-900/50 transition-colors ${row.verified ? 'bg-emerald-900/10' : ''}`}
                                                    >
                                                        <td className="px-3 py-2.5 text-center text-slate-600">{row.id}</td>
                                                        <td className="px-3 py-2.5">
                                                            <span className={`px-1.5 py-0.5 rounded text-[9px] font-bold ${
                                                                row.op === 'INPUT' ? 'bg-slate-800 text-slate-500' :
                                                                row.op === 'PRICE' ? 'bg-indigo-900/50 text-indigo-300' :
                                                                'text-cyan-600 bg-cyan-950/10'
                                                            }`}>
                                                                {row.op}
                                                            </span>
                                                        </td>
                                                        <td className="px-3 py-2.5 text-slate-400 font-sans truncate max-w-[150px] md:max-w-none">
                                                            {row.desc}
                                                        </td>
                                                        <td className="px-3 py-2.5 text-right text-slate-200 font-bold">
                                                            {Math.abs(row.value) < 0.01 && row.value !== 0 ? row.value.toExponential(2) : row.value.toFixed(3)}
                                                        </td>
                                                        <td className="px-3 py-2.5 text-right text-slate-600 font-mono text-[9px]">
                                                            {row.hash ? row.hash.substr(0, 6) : '-'}
                                                        </td>
                                                        <td className="px-3 py-2.5 text-center">
                                                            {row.verified === true ? (
                                                                <div className="flex items-center justify-center gap-1 text-emerald-500 font-bold text-[10px]">
                                                                    <CheckCircle className="w-3.5 h-3.5" /> OK
                                                                </div>
                                                            ) : row.verified === false ? (
                                                                <div className="flex items-center justify-center gap-1 text-red-500 font-bold text-[10px]">
                                                                    <XCircle className="w-3.5 h-3.5" /> FAIL
                                                                </div>
                                                            ) : (
                                                                <div className="w-1.5 h-1.5 rounded-full bg-slate-800 mx-auto" />
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        <div className="mt-6 px-4 pb-12 md:pb-8 text-[10px] text-slate-600 text-center font-mono">
                                            ルートハッシュ (Root Hash): <span className="text-slate-500 block md:inline mt-1 md:mt-0">{result?.rootHash}</span>
                                        </div>
                                    </div>
                                )}

                                {/* TAB: 外部ログ検証 */}
                                {activeTab === 'import' && (
                                    <div className="h-full overflow-auto p-6 flex flex-col items-center justify-start gap-6">
                                        <div className="w-full max-w-lg bg-slate-900 border border-slate-800 rounded-xl p-6 text-center shadow-lg">
                                            <Upload className="w-10 h-10 text-slate-600 mx-auto mb-4" />
                                            <h3 className="text-sm font-bold text-slate-200 mb-2">外部ログ検証ラボ</h3>
                                            <p className="text-xs text-slate-500 mb-4 leading-relaxed">
                                                別の環境（Python, Goなど）で出力された台帳データ(JSON)をここに貼り付けて、
                                                その数学的正当性と改ざんの有無を独立して検証できます。
                                            </p>
                                            <textarea
                                                className="w-full h-32 bg-slate-950 border border-slate-800 rounded-lg p-3 text-[10px] font-mono text-slate-400 mb-4 focus:outline-none focus:border-indigo-500 transition-colors resize-none"
                                                placeholder='JSONデータを貼り付けてください: { "ledger": [...] }'
                                                value={importJson}
                                                onChange={(e) => setImportJson(e.target.value)}
                                            />
                                            <button 
                                                onClick={handleImportVerify}
                                                disabled={!importJson || isImportVerifying}
                                                className="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-2 transition-all active:scale-[0.98]"
                                            >
                                                {isImportVerifying ? <RotateCcw className="w-3.5 h-3.5 animate-spin" /> : <ShieldCheck className="w-3.5 h-3.5" />}
                                                外部ログを検証
                                            </button>
                                        </div>

                                        {importResult && (
                                            <div className={`w-full max-w-lg rounded-xl border p-4 animate-in slide-in-from-bottom-2 shadow-lg ${importResult.ok ? 'bg-emerald-950/20 border-emerald-500/30' : 'bg-red-950/20 border-red-500/30'}`}>
                                                <div className="flex items-center gap-3 mb-4">
                                                    <div className={`p-2 rounded-full ${importResult.ok ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
                                                        {importResult.ok ? <CheckCircle className="w-6 h-6" /> : <XCircle className="w-6 h-6" />}
                                                    </div>
                                                    <div>
                                                        <div className={`text-sm font-bold ${importResult.ok ? 'text-emerald-400' : 'text-red-400'}`}>
                                                            {importResult.ok ? "検証成功 (Verified)" : "検証失敗 (Failed)"}
                                                        </div>
                                                        <div className="text-[10px] text-slate-500 font-mono">
                                                            Kernel: {importResult.kernel}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {importResult.error ? (
                                                    <div className="text-xs text-red-300 bg-red-950/30 p-3 rounded-lg border border-red-500/20 font-mono">
                                                        エラー: {importResult.error}
                                                    </div>
                                                ) : (
                                                    <div className="grid grid-cols-2 gap-3 text-xs">
                                                        <div className={`p-3 rounded-lg border ${importResult.numericOk ? 'bg-emerald-500/10 border-emerald-500/20' : 'bg-red-500/10 border-red-500/20'}`}>
                                                            <div className="text-[10px] uppercase font-bold opacity-70 mb-1">数値の正当性</div>
                                                            <div className={`font-bold ${importResult.numericOk ? 'text-emerald-300' : 'text-red-300'}`}>{importResult.numericOk ? '正常 (誤差範囲内)' : '異常あり'}</div>
                                                        </div>
                                                        <div className={`p-3 rounded-lg border ${importResult.hashOk ? 'bg-emerald-500/10 border-emerald-500/20' : 'bg-red-500/10 border-red-500/20'}`}>
                                                            <div className="text-[10px] uppercase font-bold opacity-70 mb-1">チェーン整合性</div>
                                                            <div className={`font-bold ${importResult.hashOk ? 'text-emerald-300' : 'text-red-300'}`}>{importResult.hashOk ? '正常 (改ざんなし)' : '破損あり'}</div>
                                                        </div>
                                                        <div className="col-span-2 p-3 bg-slate-900 rounded-lg border border-slate-800">
                                                            <div className="text-[10px] uppercase font-bold text-slate-500 mb-1">ルートハッシュ (Root Hash)</div>
                                                            <div className="font-mono text-[10px] text-slate-300 break-all">{importResult.rootHash}</div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                            </div>

                        </div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<FinanceAdic />);
    </script>
</body>
</html>
